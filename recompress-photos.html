<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì§„ ì¬ì••ì¶• ë„êµ¬</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #ff6b9d;
            margin-bottom: 20px;
        }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-line {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
        .warning { color: #ff9800; }
        button {
            background: #ff6b9d;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #ff5a8c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b9d;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ ì‚¬ì§„ ì¬ì••ì¶• ë„êµ¬</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalPhotos">0</div>
                <div class="stat-label">ì „ì²´ ì‚¬ì§„</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="compressedPhotos">0</div>
                <div class="stat-label">ì••ì¶• ì™„ë£Œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="savedSize">0 MB</div>
                <div class="stat-label">ì ˆì•½ëœ ìš©ëŸ‰</div>
            </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeSizes()">ğŸ“Š í¬ê¸° ë¶„ì„</button>
        <button id="compressBtn" onclick="compressAllPhotos()" disabled>ğŸ”§ ì „ì²´ ì¬ì••ì¶• (1000px, 80%)</button>
        <button id="refreshBtn" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

        <div class="status" id="status">
            <div class="status-line info">ì¤€ë¹„ ì™„ë£Œ. 'í¬ê¸° ë¶„ì„' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let photos = [];
        let totalSaved = 0;

        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const line = document.createElement('div');
            line.className = `status-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.appendChild(line);
            status.scrollTop = status.scrollHeight;
        }

        async function analyzeSizes() {
            log('ğŸ“¡ ì„œë²„ì—ì„œ ì‚¬ì§„ ë°ì´í„° ë¡œë”© ì¤‘...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/photos`);
                const result = await response.json();
                
                if (result.success) {
                    photos = result.data;
                    document.getElementById('totalPhotos').textContent = photos.length;
                    
                    log(`âœ… ${photos.length}ê°œ ì‚¬ì§„ ë¡œë“œ ì™„ë£Œ`, 'success');
                    
                    let totalSize = 0;
                    photos.forEach((photo, index) => {
                        const size = (photo.dataUrl.length / 1024).toFixed(2);
                        totalSize += parseFloat(size);
                        log(`ì‚¬ì§„ ${index + 1}: ${photo.title} - ${size} KB`, 'info');
                    });
                    
                    log(`ğŸ“Š ì´ ë°ì´í„° í¬ê¸°: ${(totalSize / 1024).toFixed(2)} MB`, 'warning');
                    
                    if (totalSize > 5000) {
                        log(`âš ï¸ í¬ê¸°ê°€ í½ë‹ˆë‹¤! ì¬ì••ì¶•ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`, 'warning');
                        document.getElementById('compressBtn').disabled = false;
                    } else {
                        log(`âœ… í¬ê¸°ê°€ ì ì ˆí•©ë‹ˆë‹¤.`, 'success');
                    }
                } else {
                    log('âŒ ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        function compressImage(dataUrl, maxWidth = 1000, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
            });
        }

        async function compressAllPhotos() {
            if (!confirm(`${photos.length}ê°œì˜ ì‚¬ì§„ì„ ì¬ì••ì¶•í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ëª‡ ë¶„ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
                return;
            }

            document.getElementById('compressBtn').disabled = true;
            document.getElementById('analyzeBtn').disabled = true;
            
            log('ğŸš€ ì¬ì••ì¶• ì‹œì‘...', 'info');
            
            let compressedCount = 0;
            totalSaved = 0;

            for (let i = 0; i < photos.length; i++) {
                const photo = photos[i];
                log(`ğŸ”„ [${i + 1}/${photos.length}] ${photo.title} ì••ì¶• ì¤‘...`, 'info');
                
                const originalSize = (photo.dataUrl.length / 1024).toFixed(2);
                
                try {
                    const compressedDataUrl = await compressImage(photo.dataUrl, 1000, 0.8);
                    const compressedSize = (compressedDataUrl.length / 1024).toFixed(2);
                    const saved = (originalSize - compressedSize).toFixed(2);
                    totalSaved += parseFloat(saved);
                    
                    // ì„œë²„ì— ì—…ë°ì´íŠ¸
                    const updateResponse = await fetch(`${API_BASE}/api/photos/${photo.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...photo,
                            dataUrl: compressedDataUrl
                        })
                    });
                    
                    const updateResult = await updateResponse.json();
                    
                    if (updateResult.success) {
                        compressedCount++;
                        log(`âœ… [${i + 1}/${photos.length}] ${photo.title}: ${originalSize}KB â†’ ${compressedSize}KB (${saved}KB ì ˆì•½)`, 'success');
                        
                        document.getElementById('compressedPhotos').textContent = compressedCount;
                        document.getElementById('savedSize').textContent = (totalSaved / 1024).toFixed(2) + ' MB';
                    } else {
                        log(`âŒ [${i + 1}/${photos.length}] ${photo.title} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨`, 'error');
                    }
                } catch (error) {
                    log(`âŒ [${i + 1}/${photos.length}] ${photo.title} ì••ì¶• ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
            
            log(`ğŸ‰ ì¬ì••ì¶• ì™„ë£Œ! ${compressedCount}/${photos.length} ì„±ê³µ, ${(totalSaved / 1024).toFixed(2)}MB ì ˆì•½`, 'success');
            log(`ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.`, 'info');
            
            document.getElementById('analyzeBtn').disabled = false;
        }
    </script>
</body>
</html>
